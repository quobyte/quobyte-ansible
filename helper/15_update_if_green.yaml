- hosts: quobyteservers 
  serial: 1
  vars_files:
    - ../vars/ansible-vars
  become: yes
  vars: 
    # You can set explicit Quobyte versions here, for example to do a rollback
    #quobyte_version: =2:3.0~pre8.1
    #quobyte_version: =2:3.0~pre9-1
    #quobyte_version: =2:3.0~pre9.1-1
    quobyte_version: "-3.0~pre11-2.1" 

  tasks:
    - name: Get Quobyte session 
      shell:
        cmd: qmgmt -u {{ api_service }} user login {{ admin_user }} {{ admin_password }} 

    - name: Wait for healthmanager to react
      pause: 
        seconds: 30

    - name: Test if Quobyte 3.x cluster is HEALTHY 
      shell:
        cmd: qmgmt -u {{ api_service }} healthmanager status | grep system_health | awk '{print $2}'
      register: systemhealth_test
      retries: 50
      delay: 5
      until: "'HEALTHY' in systemhealth_test.stdout"
      when: repo_id is not defined 

    - name: Test if Quobyte 2.x cluster is HEALTHY 
      shell:
        cmd: qmgmt -u {{ api_service }} hm status | grep system_health | awk '{print $2}'
      register: systemhealth_test
      retries: 50
      delay: 5
      until: "'HEALTHY' in systemhealth_test.stdout"
      when: repo_id is defined 

    - debug:
        var: systemhealth_test

    - name: Install Debian packages
      apt:
        name: "{{ packages }}"
        state: present
        update_cache: yes
      vars:
        packages:
        - quobyte-server{{ quobyte_version }}
      when: ansible_facts['os_family'] == "Debian" and "'HEALTHY' in systemhealth_test.stdout" 

    - name: Install RPM packages
      yum: 
        update_cache: yes
        allow_downgrade: yes
        state: present 
        name: "{{ packages }}"
      vars:
        packages:
        - quobyte-server{{ quobyte_version }}
      when: ansible_facts['os_family'] == "RedHat" and "'HEALTHY' in systemhealth_test.stdout"

