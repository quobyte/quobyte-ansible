- hosts: registryservices[0]
  vars_files:
    - ../vars/ansible-vars
  vars:
    - cluster_name: "Enjoy Distributed Storage"
    - healthmanager_enabled: true
  become: yes
  tasks:

    - name: Dump cluster config to variable 
      uri:
        url: "http://{{api_service}}:7860"
        user: "{{admin_user}}"
        password: "{{admin_password}}"
        force_basic_auth: yes
        method: POST
        body_format: json
        body: "{ \"id\": \"text\",\"jsonrpc\": \"2.0\", \"method\": \"getConfiguration\", \"params\": { \"configuration_type\": \"SYSTEM_CONFIGURATION\", \"retry\": \"INFINITELY\" } }"
        return_content: yes
      register: systemconfig_dump_raw 

    - name: Get systemconfig 
      set_fact: 
        systemconfig: "{{ systemconfig_dump_raw.json.result.system_configuration }}"

    - debug:
            var: systemconfig

    - name: Create new systemconfig
      set_fact:
        systemconfig_var: "{{ systemconfig_var | default([]) | combine({ 'method': 'setConfiguration', 'id': 'text', 'jsonrpc': '2.0', 'params': {'configuration_type': 'SYSTEM_CONFIGURATION', 'system_configuration': '{{ systemconfig }}' } }) }}"

#    - name: Set some variable 
#      set_fact:
#        systemconfig_var: "{{ systemconfig_var|combine({'params': {'system_configuration': {'cluster_configuration': {'cluster_name': 'Enjoy Distributed storage'}}}}, recursive=True) }}"

    - name: Set some other variable 
      set_fact:
        systemconfig_var: "{{ systemconfig_var|combine({'params': {'system_configuration': {'health_manager_config': {'enable': true }}}}, recursive=True) }}"

    - debug:
            var: systemconfig_var


    - name: Write cluster config to Quobyte 
      uri:
        url: "http://{{api_service}}:7860"
        user: "{{admin_user}}"
        password: "{{admin_password}}"
        force_basic_auth: yes
        method: POST
        body_format: json
        body: "{{ systemconfig_var }}"
